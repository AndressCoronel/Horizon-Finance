generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Currency {
  USD
  ARS
}

enum TransactionType {
  BUY
  SELL
  DEPOSIT_USD
  DEPOSIT_ARS
}

model User {
  id                String        @id @default(cuid())
  clerkId           String        @unique
  email             String        @unique
  firstName         String?
  lastName          String?
  preferredCurrency Currency      @default(USD)
  cashBalanceUSD    Decimal       @default(0) @db.Decimal(18, 8)
  cashBalanceARS    Decimal       @default(0) @db.Decimal(18, 2)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  portfolio    Portfolio?
  transactions Transaction[]

  @@map("users")
}

model Portfolio {
  id        String     @id @default(cuid())
  userId    String     @unique
  name      String     @default("Mi Portfolio")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  positions Position[]

  @@map("portfolios")
}

model Asset {
  id           String        @id @default(cuid())
  coinGeckoId  String        @unique
  symbol       String
  name         String
  image        String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  positions    Position[]
  transactions Transaction[]

  @@map("assets")
}

model Position {
  id              String   @id @default(cuid())
  portfolioId     String
  assetId         String
  quantity        Decimal  @db.Decimal(18, 8)
  averageBuyPrice Decimal  @db.Decimal(18, 8)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  portfolio Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  asset     Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([portfolioId, assetId])
  @@map("positions")
}

model Transaction {
  id           String          @id @default(cuid())
  userId       String
  assetId      String?
  type         TransactionType
  quantity     Decimal?        @db.Decimal(18, 8)
  pricePerUnit Decimal?        @db.Decimal(18, 8)
  totalAmount  Decimal         @db.Decimal(18, 8)
  currency     Currency        @default(USD)
  createdAt    DateTime        @default(now())

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  asset Asset? @relation(fields: [assetId], references: [id], onDelete: SetNull)

  @@map("transactions")
}
